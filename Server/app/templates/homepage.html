{% extends "paginaBase.html" %}

{% block content %}

<div id="page-wrapper">


  <div class="visible-xs visible-sm responsive-menu">
    <a href="#" class="toggle-menu">
        <i class="fa fa-bars"></i> Show Menu
    </a>
    <div class="show-menu">
      <ul class="main-menu">
        <li>
            <a class="show-1 active homebutton" href="#"><i class="fa fa-home"></i>Home</a>
        </li>
        <li>
            <a class="show-2 agendaButton" href="#"><i class="fa fa-book"></i>Agenda</a>
        </li>
        <li>
            <a class="show-3 calendarButton" href="#"><i class="fa fa-calendar"></i>Calendario</a>
        </li>
          {% if dipendente.dirigente%}
        <li>
            <a class="show-4 gestioneDipButton" href="#"><i class="fa fa-user-plus"></i>Gestione <br/> Dipendenti</a>
        </li>
          {% endif %}
          {% if dipendente.classe == 'commerciale' or  dipendente.dirigente %}
        <li>
            <a class="show-5 accoglienzaButton" href="#"><i class="fa fa-address-book-o"></i>Accogli <br/> Cliente</a>
        </li>
          {% endif %}

        <li>
            <a class="show-6 contactbutton" href="#"><i class="fa fa-envelope"></i>Invia un email</a>
        </li>
      </ul>
    </div>
  </div>


<!--==================================================================================================-->


  <header id="header" data-ng-include="'header'" data-ng-controller="headerCtrl as hctrl"></header>
  <aside id="sidebar" data-ng-include="'sidebarLeft'" data-ng-class="{ 'toggled': mactrl.sidebarToggle.left === true }"></aside>

  <aside id="chat" data-ng-include="'/static/headerAndForm/template/chat.html'" data-ng-class="{ 'toggled': mactrl.sidebarToggle.right === true }"></aside>

  <section id="main">
    <section id="content">
      <div class="container" id="page-content">

        <div class="row" id="row-content">

          <div id="colonnaSx" class="col-md-2 hidden-sm">

            <nav id="nav" class="main-navigation hidden-xs hidden-sm">
              <ul class="main-menu">
                <li>
                    <a class="show-1 active homebutton" href="#"><i class="fa fa-home"></i>Home</a>
                </li>
                <li>
                    <a class="show-2 agendaButton" href="#"><i class="fa fa-book"></i>Agenda</a>
                </li>
                <li>
                    <a class="show-3 calendarButton" href="#"><i class="fa fa-calendar"></i>Calendario</a>
                </li>
                {% if dipendente.dirigente%}
                <li>
                    <a class="show-4 gestioneDipButton" href="#"><i class="fa fa-user-plus"></i>Gestione <br/> Dipendenti</a>
                </li>
                {% endif %}

                {% if dipendente.classe == 'commerciale' or  dipendente.dirigente  %}
                <li>
                    <a class="show-5 accoglienzaButton" href="#"><i class="fa fa-address-book-o"></i>Accogli <br/> Cliente</a>
                </li>
                {% endif %}

                <li>
                    <a class="show-6 contactbutton" href="#"><i class="fa fa-envelope"></i>Invia un email</a>
                </li>
              </ul>
            </nav>

          </div> <!-- fine colonnaSx -->


          <div class="col-md-8 col-sm-12 content-holder" id="colonnaCentrale">
            <div id="menu-container">

              <div id="menu-1" class="row homepage home-section text-center">
                <div class="welcome-text col-md-12 col-sm-12">

                  <h2>Welcome  <span class="red"> {{dipendente.nome}} {{dipendente.cognome}}</span></h2>
                  <p> <span class="orange">{{dipendente.classe}}
                  {%if dipendente.dirigente%} dirigente {% endif %}</span></p>

                    <div id="noteDipendenti"  class="row">


            <div class="row righe-homepage">
              <div class="col-md-3"></div>
              <div class="col-sm-12 col-md-6">
                {% raw %}
                  <!-- Todo Lists -->
                  <div id="todo-lists" data-ng-controller="todoCtrl as tctrl">
                    <div class="tl-header">
                        <h2>Impegni lavorativi</h2>
                        <small>Memorandum degli impegni di lavoro</small>

                    </div>

                    <div class="clearfix"></div>

                    <div class="tl-body">


                        <div id="add-tl-item" data-ng-class="{ 'toggled': tctrl.addTodoStat }" data-ng-click="tctrl.addTodoStat = true">
                            <i class="add-new-item zmdi zmdi-plus" data-ng-click="tctrl.addTodo($event)"></i>

                            <div class="add-tl-body">
                                <textarea id="textImpegno" placeholder="Testo..." data-ng-model="tctrl.todo"></textarea>

                                <div class="add-tl-actions">

                                    {% if dipendente.dirigente %}
                                    <select id="dipImpegni">
                                        <option>Personale</option>
                                        <option>matteo_cittadini</option>
                                        <option>Franzo</option>
                                    </select>
                                    {% endif %}

                                    <a class="zmdi zmdi-close" data-tl-action="dismiss" data-ng-click="tctrl.addTodoStat = false; $event.stopPropagation()"></a>
                                    <a id="addImpegno" class="zmdi zmdi-check" data-tl-action="save" data-ng-click="tctrl.addTodoStat = false; $event.stopPropagation()"></a>
                                </div>

                            </div>
                        </div>


                        <div id="contentImpegni" class="checkbox media" >
                        <!--    <div class="pull-right">
                                <a id="delImpegno" href="" > × </a>
                            </div>
                            <div class="media-body">
                                <label>
                                    <input id="checkImpegni" type="checkbox">
                                    <i class="input-helper"></i>
                                    <span> &emsp;</span>
                                </label>
                            </div> -->
                        </div>

                    </div>
                  </div>
                {% endraw %}
              </div>
              <div class="col-md-3"></div>
            </div>


                    </div>

                </div> <!-- fine welcome-text -->

              </div> <!-- fine homepage -->

    <!--============================ Sezioni "chiamate" via Ajax =====================================-->

              <div id="menu-2" class="row content calendario-section col-md-6 col-sm-12">
                  <div id='calendar-agenda' data-full-calendar class="agenda"></div>

              </div>

             <div id="menu-3" class="content col-md-6 col-sm-12">
                <div id='calendar-calendario'></div>
             </div>

              <div id="menu-4" class="content gestioneDip-section col-sm-12">

              </div>

              <div id="menu-5" class="content accoglienza-section col-sm-12">

              </div>

              <div id="menu-6" class="content profiloDip-section col-sm-12">

              </div>


    <!--==============================================================================================-->

            </div> <!-- fine menu-container -->
          </div> <!-- fine colonnaCentrale -->




        </div> <!-- fine row-content -->
      </div> <!-- fine page content -->

    </section>
  </section>

<!--===================================================================================================-->

</div> <!-- fine page-wrapper -->

<script>

  var socketCalendario = io.connect("{{sockUrl}}"+'/calendario');

  $('.agenda').fullCalendar({
      header: {
        left: 'prev,next today',
        center: 'title',
        right: 'month,agendaWeek,agendaDay,listWeek'
      },
      navLinks: true, // can click day/week names to navigate views
      editable: true,
      eventDurationEditable: true,
      eventLimit: true, // allow "more" link when too many events
      views: {
          agenda: {
            eventLimit: 3 // adjust to 6 only for agendaWeek/agendaDay
          }
      },
      events: [
        {% for evento in agenda %}
        {
          title: '{{evento.titolo}}\n{{evento.luogo}}',
          start: '{{evento.start_date}}',
          color: 'blue'
        },
        {% endfor %}
       ],

      eventMouseout: function( event, jsEvent, view ){
        $('#popupEvent-over').each(function(){
            $('.Hunter-pop-up').remove();
        });

        $('.popover').remove();
      },

      eventMouseover: function( event, jsEvent, view ) {
        jsEvent.preventDefault();
        jsEvent.stopPropagation();

        $('body').append(
            '<div id="popupEvent-over" style="display:none"> \
                <div> \
                    <div class="panel panel-default"> \
                        <div class="panel-heading subtitle">Accompagnatori:</div> \
                        <div class="panel-body form-inline dept1"> \
                          <ul> \
                            <li>ACC1</li> \
                            <li>ACC2</li> \
                            <li>ACC3</li> \
                          </ul> \
                        </div> \
                    </div> \
                </div> \
            </div>'
        );


        var popupEvent = function() {

        }

        $(this).hunterPopup({

                width: '320px',
                height: '200px',
                title: event.title,
                content: $('#popupEvent-over'),
                event: popupEvent

        });

        $(this).trigger('launch-popup-over');

      },

      eventClick: function(calEvent, jsEvent, view) {

           jsEvent.preventDefault();
           jsEvent.stopPropagation();

           $('body').append(
                '<div id="popupEvent-click" style="display:none"> \
                    <div> \
                        <div class="panel panel-default"> \
                            <div class="panel-heading subtitle">Durata evento:</div> \
                            <div class="panel-body form-inline dept1"> \
                              <label for="inizio_evento">Orario inizio:</label> \
                              <input id="inizio_evento" type="time"> <br/>\
                              <label for="fine_evento">Orario fine:</label> \
                              <input id="fine_evento" type="time"> \
                            </div> \
                            <div class="panel-heading subtitle">Selezione accompagnatori:</div> \
                            <div class="panel-body form-inline dept1 accompagnatori-div"> \
                              <label for="num_accompagnatori">Numero accompagnatori:</label> \
                              <input id="num_accompagnatori" type="number" value="0" min="0" max="5"> <br/>\
                            </div> \
                        </div> \
                    </div> \
                </div>'
           );


            var popupEvent = function() {
                $('#num_accompagnatori').change(function(){
                    $(".select-accompagnatori").remove();
                    $(".spazio").remove();

                    for( i=0; i < $('#num_accompagnatori').val(); i++ ){

                        $('.accompagnatori-div').append(
                            '<select class="select-accompagnatori"> \
                                <option>Scetulin de scetulinis</option> \
                                <option>Nicola Pancheri</option> \
                            </select><br class="spazio"/>'
                        );
                    }

                });
            }

            $(this).hunterPopup({

                width: '320px',
                height: '200px',
                title: calEvent.title,
                content: $('#popupEvent-click'),
                event: popupEvent

            });

            $(this).trigger('launch-popup-click');


      },
      dayClick: function(date, jsEvent, view) {



        if( view.name == 'month'){

            giornoSelected = $(this)
            $('.clicked').each(function(){
              if( !$(this).is(giornoSelected) ){
                $(this).removeClass('clicked');
                $(this).popover('hide');
              }
            });

            if( !$(this).hasClass('clicked') ){
              $(this).addClass('clicked');
              contenuto = ' <div> \
                              <div id="agenda-add-event" class="popover-option">Aggiungi appuntamento</div>     \
                            </div> \
                          '

              $(this).popover({
                  trigger: 'manual',
                  container: 'body',
                  html:true,
                  content: contenuto
              });

              $(this).popover('show');

              $('#agenda-add-event').click(function(){

                    swal.withFormAsync({
                        title: 'Nuovo evento',
                        showCancelButton: true,
                        confirmButtonColor: '#DD6B55',
                        confirmButtonText: 'Ok',
                        cancelButtonText: 'annulla',
                        closeOnConfirm: true,
                        formFields: [

                            { id: 'titolo', label: 'Titolo evento:', name: 'titolo',  placeholder: 'titolo evento' },

                            { id: 'durata',  type: 'number', label: 'Durata giorni evento:', name: 'durata', value: 1 },



                        ]
                    }).then(function (context) {
                        if(context._isConfirm){

                            var start_date = moment( date.format() )
                            var end_date = moment( date.format() ).add( parseInt(context.swalForm['durata']), 'd')

                            $('.agenda').fullCalendar( 'addEventSource', {


                              events: [
                                {
                                  title  : context.swalForm['titolo'],
                                  start  : start_date,
                                  end : end_date
                                }
                              ]}
                            );

                            $('.clicked').popover('hide');
                            $('.clicked').removeClass('clicked');



                        }
                        else{
                            $('.clicked').popover('hide');
                            $('.clicked').removeClass('clicked');
                        }

                    });



              });
            }
            else{
                $(this).removeClass('clicked');
                $(this).popover('hide');
            }
        }
        else if( view.name == 'agendaWeek' ){
            console.log('week');

        }
        else if( view.name == 'agendaDay' ){
            console.log('day');

        }
      }
  });


/*
    Gestione della scomparsa dei popup dall'agenda
*/

  $('.fc-button').click(function(){
     $('.popover').remove();
     $('.clicked').removeClass('clicked');
  });

  $('.fc-view-container').mouseover(function(){
    $('.popover').remove();
  });

  $('.fc-view-container').mouseleave(function(){

    //Se il mouse e' sopra un popup element non elimina il popup
    if (!$('.Hunter-pop-up:hover').length != 0) {
        $('.Hunter-pop-up').remove();
    }
  });

  $('#row-content').mouseover(function(){
    $('.popover').remove();
  });

/******************************************************************/


 /* Collego i bottoni alle pagine che devono ritornare */

    var chiamatoCalendario = false;
    var chiamataAgenda = false;

	$(".main-menu a").click(function(){
		var id =  $(this).attr('class');
		id = id.split('-');
        idNum=id[1].split(' ')[0];

		// se sto scegliendo l'opzione calendario o agenda, mi ritrovo a dover usare
		// delle librerie che necessitano della creazione di un div con id "calendar".
		// Poiche' ho due sezioni con due elementi con stesso id, differenzo gli id che
		// dovrebbero essere uguali e quando la relativa sezione verra' chiamato gli
		// assegno l'id "corretto"

		if( idNum == '3' ){
		    chiamatoCalendario = true;

		    if( chiamataAgenda ){
		        chiamataAgenda = false;
		        $('#calendar').attr('id', 'calendar-agenda');
		    }

		    $('#calendar-calendario').attr('id', 'calendar');

            function saveEvent(e, titolo, luogo, durata) {

                var end_date = moment(e.date).add(durata-1, 'd').toDate();

                var dataSource = $('#calendar').data('calendar').getDataSource();
                dataSource.push({startDate: e.date, endDate: end_date, name: titolo, location: luogo})
                $('#calendar').data('calendar').setDataSource(dataSource);

                 socketCalendario.emit('aggiungi_evento', {
                    'dip': '{{dipendente.username}}',
                    'titolo': titolo,
                    'start_date': moment(e.date).add(1, 'd').toDate(),
                    'end_date': moment(end_date).add(1, 'd').toDate(),
                    'luogo': luogo,
                });
            }

            function editEvent(event) {
              $('#event-modal input[name="event-index"]').val(event ? event.id : '');
              $('#event-modal input[name="event-name"]').val(event ? event.name : '');
              $('#event-modal input[name="event-location"]').val(event ? event.location : '');
              $('#event-modal input[name="event-start-date"]').datepicker('update', event ? event.startDate : '');
              $('#event-modal input[name="event-end-date"]').datepicker('update', event ? event.endDate : '');
              $('#event-modal').modal();
            }

            function deleteEvent(event) {
              var dataSource = $('#calendar').data('calendar').getDataSource();

              for(var i in dataSource) {
                  if(dataSource[i].id == event.id) {
                      dataSource.splice(i, 1);
                      break;
                  }
              }

              $('#calendar').data('calendar').setDataSource(dataSource);
            }

            var currentYear = new Date().getFullYear();

            $('#calendar').calendar(

              {
                 enableContextMenu: true,
                 enableRangeSelection: true,
                 language: 'it',
                 dataSource: [

                   {% for evento in calendario %}
                    {% if not evento.tipologia %}
                       {


                           name: 'Ferie {{evento.dipendente}}',
                           location: '',
                           startDate: moment('{{evento.start_date}}').toDate(),
                           endDate: moment('{{evento.end_date}}').toDate(),
                           color: 'green'
                       },
                    {% else %}
                       {

                           name: '{{evento.titolo}}',
                           location: '{{evento.luogo}}',
                           startDate: moment('{{evento.start_date}}').toDate(),
                           endDate: moment('{{evento.end_date}}').toDate()
                       },
                    {% endif %}
                   {% endfor %}

                 ],

                 mouseOnDay: function(e) {

                    //alert(' io entavo ' + $('#calendar').data('calendar').getEvents(e.date).length);

                     if(e.events.length > 0) {

                         $('#popupEvent-year-cal').remove();

                         var content = '';

                         for(var i in e.events) {
                             content += '<div class="panel-heading subtitle">'+ e.events[i].name +
                                            '<div class="popup-ctrl-btns"><button>Modifica</button><button>Elimina</button></div> \
                                         </div> \
                                         <div class="panel-body form-inline dept1"> \
                                          questo è il contenuto di questo evento :) \
                                         </div>'
                         }



                         $('body').append(
                            '<div id="popupEvent-year-cal" style="display:none"> \
                                <div> \
                                    <div class="panel panel-default">'+
                                     content +
                                    '</div> \
                                </div> \
                            </div>'
                         );

                         var popupEvent = function() {

                         }


                         $(e.element).hunterPopup({

                            width: '320px',
                            height: '200px',
                            title: "Eventi del giorno",
                            content: $('#popupEvent-year-cal'),
                            event: popupEvent

                         });

                         $(e.element).trigger('launch-popup-overYear');


                     }

                 },
                 mouseOutDay: function(e) {
                    if (!$('.Hunter-pop-up:hover').length != 0) {
                        $('.Hunter-pop-up').remove();
                    }

                 },


                clickDay: function(e) {

                    $('.Hunter-pop-up').remove();

                    giornoSelected = $(e.element);

                    $('.clicked').each(function(){
                      if( !$(this).is(giornoSelected) ){
                        $(this).removeClass('clicked');
                        $(this).popover('hide');
                      }
                    });

                    if( !giornoSelected.hasClass('clicked') ){

                      giornoSelected.addClass('clicked');
                      content = ''


                      content = ' <div> \
                                  <div id="cal-add-event" class="popover-option">Aggiungi evento</div>     \
                                  </div> \
                                '

                      giornoSelected.popover({
                          trigger: 'manual',
                          container: 'body',
                          html:true,
                          content: content
                      });

                      giornoSelected.popover('show');








                      $('#cal-add-event').click(function(){
                            swal.withFormAsync({
                                title: 'Aggiungi evento',
                                showCancelButton: true,
                                confirmButtonColor: '#DD6B55',
                                confirmButtonText: 'Ok',
                                cancelButtonText: 'annulla',
                                closeOnConfirm: true,
                                formFields: [

                                    { id: 'titolo', label: 'Titolo evento:', name: 'titolo', placeholder: 'titolo evento' },
                                    { id: 'luogo', label: 'Luogo evento:', name: 'luogo',  placeholder: 'luogo evento' },
                                    { id: 'durata', type: 'number', label: 'Durata giorni evento:', name: 'durata', value: 1 },

                                ]
                            }).then(function (context) {
                                if(context._isConfirm){

                                    saveEvent(e, context.swalForm['titolo'], context.swalForm['luogo'], context.swalForm['durata']);

                                }

                            });



                            $('.popover').remove();
                            $('.clicked').removeClass('clicked');


                      });
                    }
                    else {
                        giornoSelected.removeClass('clicked');
                        giornoSelected.popover('hide');

                    }
                }
              }
            )



		}
		else if( idNum == '2'){
		    chiamataAgenda =true;

		    if( chiamatoCalendario ){
		        chiamatoCalendario = false;
		        $('#calendar').attr('id', 'calendar-calendario');
		    }

		    $('#calendar-agenda').attr('id', 'calendar');

		}

        if( idNum != '3'){
            $('.popover').remove();
        }
         if( idNum != '2'){
            $('.popover').remove();
        }

        //Elimina i popup se si esce dal calendario evitando di doverli chiudere a mano
        $('#menu-container').mouseout(function(){
            //Se il mouse e' sopra un popup element non elimina il popup
            if (!$('.Hunter-pop-up:hover').length != 0) {
                $('.Hunter-pop-up').remove();
            }
        });

		$('a.active').removeClass('active');
	  	$(this).addClass('active');
		$("#menu-container .content").slideUp('slow');
		$("#menu-container .homepage").slideUp('slow');

		$("#menu-container #menu-"+id[1]).slideDown('slow');
        console.log('SOno dwsds '+ $('#menu-3').attr('class'))
        if( idNum != '3'){
            $('#menu-3').removeClass('force-show');
		    $('#menu-3').addClass( 'force-hide' );

		}else{
		    $('#menu-3').removeClass('force-hide');
		    $('#menu-3').addClass( 'force-show' );

        }
         console.log('SOno dwsds '+ $('#menu-3').attr('class'))

		return false;
	});


	$(".main-menu a.homebutton").click(function(){
		//	$("#menu-container .content").slideUp('slow');
			$("#menu-container .homepage").slideDown('slow');

			return false;
	});
/*
	$(".main-menu a.registraDipButton").click(function(){
			$(".registraDip-section").load("static/templates/registraDip.html #container-contact100");
			//$("#menu-container .content").slideUp('slow');
			$("#menu-container .registraDip-section").slideDown('slow');



			$.getScript("static/form/js/main.js");
			return false;
	});
*/
	$(".main-menu a.agendaButton").click(function(){
		//	$("#menu-container .content").slideUp('slow');
			$("#menu-container .calendario-section").slideDown('slow');
			$("#calendar").fullCalendar("render");
			return false;
	});


	 $(".main-menu a.profiloDipButton").click(function(){
			$(".profiloDip-section").load("{{url_for('paginaProfilo')}} #container-profiloDip");
    	    $("#menu-container .profiloDip-section").slideDown('slow');

			return false;
	 });

	 $(".main-menu a.gestioneDipButton").click(function(){
			$(".gestioneDip-section").load("{{url_for('gestioneDip')}}");
		//	$("#menu-container .content").slideUp('slow');
	    	$("#menu-container .gestioneDip-section").slideDown('slow');

			return false;
	 });

	$(".main-menu a.accoglienzaButton").click(function(){
			$(".accoglienza-section").load("{{url_for('accoglienza', error=0)}}");
			//$("#menu-container .content").slideUp('slow');
			$("#menu-container .accoglienza-section").slideDown('slow');



			$.getScript("static/form/js/main.js");
			return false;
	});


</script>

<script type="text/javascript" charset="utf-8">


    var socketHome = io.connect("{{sockUrl}}"+'/home');

    socketHome.on('connect', function() {
        console.log('connected');


        socketHome.emit('registra_sid',   {'username': '{{dipendente.username}}'} );
    });


</script>

<script>


    $('#contentImpegni').load('listImpegni');
    var socketImpegni = io.connect("{{sockUrl}}"+'/impegni');

    socketImpegni.on('aggiornaImpegni', function(){
        $('#contentImpegni').load('listImpegni');
    });

    {% if dipendente.dirigente %}
        $('#addImpegno').click(function(){


            newImpegno = $('#textImpegno').val();
            selectImpegno = $('#dipImpegni').val();

            // se non viene inserito nulla nel campo di testo
            if( newImpegno == "" )
                return;

            if( selectImpegno == "Personale" )
            {
                socketImpegni.emit('registraImpegno', {'testo': newImpegno, 'dip': '{{dipendente.username}}', 'dir': "" });
            }
            else
                socketImpegni.emit('registraImpegno', {'testo': newImpegno, 'dip': selectImpegno, 'dir': '{{dipendente.username}}'});



        });
    {% else %}

        $('#addImpegno').click(function(){


            newImpegno = $('#textImpegno').val();

            // se non viene inserito nulla nel campo di testo
            if( newImpegno == "" )

            socketImpegni.emit('registraImpegno', {'testo': newImpegno, 'dip': '{{dipendente.username}}', 'dir': "" });

        });



    {% endif %}



</script>


{% endblock %}