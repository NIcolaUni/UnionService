<div class="inner">

    <span id="titlePreventivoFinitureSpan">
        <span><h2><a id="newPreventivoFiniture" class="fa fa-plus-circle expandPreventivoIcon"></a>Preventivo Finiture</h2></span>

        {% if countPreventiviFiniture > 0 %}

            <span id="ctrlSpanPreventivoFiniture">
                <span class="aCtrlPreventivoFiniture">
                </span>
                <select id="preventivoFinitureSelect" >
                    {% for prev in preventiviFiniture_distinti %}
                        {% if prev[2] == lastPreventivoFiniture[0].numero_preventivo %}
                            <option class="numeroPreventivoFiniture-{{prev[2]}}" selected="selected">{{prev[0]}} - US{{prev[1]}}F - {{prev[3]}}</option>
                        {% else %}
                            <option class="numeroPreventivoFiniture-{{prev[2]}}">{{prev[0]}} - US{{prev[1]}}F - {{prev[3]}}</option>
                        {% endif %}
                    {% endfor %}
                </select>
                <select id="revisioneFinitureSelect" >
                </select>


            </span>
        {% endif %}
    </span>


</div>
<script>

    var socketFiniture= io.connect("{{sockUrl}}"+'/preventivoFiniture');


    $('#newPreventivoFiniture').click(function(){

        swal.withFormAsync({
            title: 'Selezionare una commessa:',
            showCancelButton: true,
            confirmButtonColor: '#DD6B55',
            confirmButtonText: 'Ok',
            cancelButtonText: 'annulla',
            closeOnConfirm: true,
            formFields: [


                { id: 'select', type: 'select',
                    options: [
                    {% for prev in preventiviEdili_distinti %}
                        {value: '{{prev[0]}}-{{prev[2]}}', text: '{{prev[0]}} - US{{prev[1]}}E'},
                    {% endfor %}

                    ]
                }

            ]
        }).then(function (context) {
            if(context._isConfirm){

                        socketFiniture.emit('registra_nuovo_preventivo_vecchia_commessa',
                                    { 'dip': '{{dipendente.username}}',
                                      'numero_preventivo': context.swalForm['select'].split('-')[1]
                                    }
                          );


            }
        });

    });


    var revisionaPreventivo = function(){


        var selectedPreventivo = $('#preventivoFinitureSelect option:selected').attr('class').split('-')[1];
        var selRevisione = $('#revisioneFinitureSelect').val();


        socketFiniture.emit('revisiona_preventivo_finiture ', {'numero_preventivo': selectedPreventivo, 'revisione': selRevisione,
                                                            'dip': '{{dipendente.username}}' });


    }

    function calcolaTotalePreventivoFiniture(numero_preventivo, data){
        var totale = 0;

        {% for preventivo in preventiviFiniture %}
            if( "{{preventivo[0].numero_preventivo}}"  == numero_preventivo &&  "{{preventivo[0].data}}"  == data ){
                {% for prodotto in preventivo[1][1] %}
                    totale += parseFloat('{{prodotto.diffCapitolato}}');
                {% endfor %}
            }

        {% endfor %}

        $('#totalePrevFiniture').html( '<button style="display:none" id="btnPrevFin">Preventivo</button><button onclick="revisionaPreventivo()" style="display:none" id="btnRevisionaFin">Revisiona</button><span>Totale: &euro; '+ Math.round(totale*100)/100 +'</span>');


    }

    var mostraPrevBtn = function(numero_preventivo, revisione){
        $('#totalePrevFiniture').css('height', 'unset');
        $('#btnPrevFin').show();
        $('#btnRevisionaFin').show();

        $('#btnPrevFin').unbind('click').click(function(){

            window.open('/downloadPreventivoFiniture/'+numero_preventivo+'/'+revisione, '_blank');
        });


    }

    var nascondiPrevBtn = function(){
        $('#totalePrevFiniture').css('height', '40px');
        $('#btnPrevFin').hide();
        $('#btnRevisionaFin').hide();

    }


    /*Stampa l'antemprima del preventivo edile*/
    function stampaRiassuntoPreventivoFiniture( numero_preventivo, data ){

                    $('section#two').children('.inner').children('.features').remove();

                    strToAdd = '';
                    {% for preventivo in preventiviFiniture %}
                        if( "{{preventivo[0].numero_preventivo}}"  == numero_preventivo &&  "{{preventivo[0].data}}"  == data ){
                            strToAdd = '<div class="features"> \
                                            <div id="tabFiniturePaginaCliente" class="table-wrapper"> \
                                                    <table class="alt"> \
                                                        <thead> \
                                                            <tr> \
                                                                <th class="tdProdotto tdString">Prodotto</th> \
                                                                <th class="tdCodice tdString">Codice</th> \
                                                                <th class="tdMarchio tdString">Marchio</th> \
                                                                <th class="tdModello tdString">Modello</th> \
                                                                <th class="tdQuantita tdShortNum">Quantità</th> \
                                                                <th class="tdUnitaMisura tdShortNum">Unità misura</th> \
                                                                <th class="tdDiffCapitolato tdLongNum">diff.<br/> CAPITOLATO </th> \
                                                            </tr> \
                                                        </thead> \
                                                    </table>';


                            {% for tipologia in preventivo[1][0] %}
                                strToAdd += '<table class="alt"> \
                                            <tbody> \
                                                <tr> \
                                                    <td colspan="7">{{tipologia}}</td> \
                                                </tr>';

                                {% for prodotto in preventivo[1][1] %}
                                    {% if prodotto.tipologia == tipologia %}
                                        strToAdd +=	'<tr> \
                                                         <td class="tdProdotto tdString">{{prodotto.nome_modificato}}</td> \
                                                         <td class="tdCodice tdString">{{prodotto.codice}}</td> \
                                                         <td class="tdMarchio tdString">{{prodotto.marchio}}</td> \
                                                         <td class="tdModello tdString">{{prodotto.modello}}</td> \
                                                         <td class="tdQuantita tdShortNum">{{prodotto.quantita}}</td> \
                                                         <td class="tdUnitaMisura tdShortNum">{{prodotto.unitaMisura}}</td> \
                                                         <td class="tdDiffCapitolato tdLongNum">&euro; {{prodotto.diffCapitolato}}</td> \
                                                     </tr>';
                                    {% endif %}
                                {% endfor %}

                                strToAdd +=	'</tbody> \
                                            </table>';
                            {% endfor %}

                            strToAdd += '<div id="totalePrevFiniture"> \
                                                    <span>Totale: </span> \
                                                </div> \
                                            </div> \
                                        </div>';
                        }
                    {% endfor %}

                    $(strToAdd).insertAfter("#titlePreventivoFinitureSpan");
                    calcolaTotalePreventivoFiniture(numero_preventivo, data);

    }


    function impostaSelectDataPreventivoFiniture(numero_preventivo){

        var firstCycle=true;
        var preventivoStatus = true;

        //resetto il select togliendo tutti i tag option
        $('#revisioneFinitureSelect').html('');

        {% for preventivo in preventiviFiniture %}
            var optionElement = "";

            // di default setto come data quella piu' recente del piu' recente preventivo
            // generato per questo cliente
            if( "{{preventivo[0].numero_preventivo}}" == numero_preventivo ){
                if( firstCycle ){
                    optionElement = '<option selected="selected" value="{{preventivo[0].revisione}}">revisione #{{preventivo[0].revisione}}</option>';
                    firstCycle=false;
                }
                else
                    optionElement = '<option value="{{preventivo[0].revisione}}">revisione #{{preventivo[0].revisione}}</option>';

                {% if not preventivo[0].stato %}

                    $('.aCtrlPreventivoFiniture').children('a').hide();
                    preventivoStatus = false;

                {% else %}

                    $('.aCtrlPreventivoFiniture').children('a').show();


                {% endif %}
            }


            $('#revisioneFinitureSelect').append( optionElement );


        {% endfor %}

        return preventivoStatus;
    }

    {% if countPreventiviFiniture > 0 %}
        $('.aCtrlPreventivoFiniture').html(
                '<a id="modificaPreventivoFiniture" class="fa fa-edit expandPreventivoIcon"></a>'+
                '<a id="cancellaPreventivoFiniture" class="fa fa-trash expandPreventivoIcon"></a>'
        );



        $('#cancellaPreventivoFiniture').click(function(){
             var selPrev = $('#preventivoFinitureSelect option:selected').attr('class').split('-')[1];
             var selRevisione = $('#revisioneFinitureSelect').val();

             socketFiniture.emit('elimina_preventivo', {'dip': '{{dipendente.username}}',
                                                          'numero_preventivo': selPrev,
                                                           'revisione': selRevisione });


        });

        var statusPreventivo = impostaSelectDataPreventivoFiniture('{{lastPreventivoFiniture[0].numero_preventivo}}');
        stampaRiassuntoPreventivoFiniture('{{lastPreventivoFiniture[0].numero_preventivo}}', '{{lastPreventivoFiniture[0].data}}');

        if( !statusPreventivo ){
            mostraPrevBtn('{{lastPreventivoFiniture[0].numero_preventivo}}', '{{lastPreventivoFiniture[0].revisione}}');
        }
        else{
            nascondiPrevBtn();
        }

    {% endif %}




    $('#preventivoFinitureSelect').change(function(){
        var selectedPreventivo = parseInt($('#preventivoFinitureSelect option:selected').attr('class').split('-')[1]);

        var statusPreventivo = impostaSelectDataPreventivoFiniture(selectedPreventivo);

        var selectedRevisione = $('#revisioneFinitureSelect').val();
        stampaRiassuntoPreventivoFiniture(selectedPreventivo, selectedRevisione);

        if( !statusPreventivo ){
            mostraPrevBtn(selectedPreventivo, selectedRevisione);
        }
        else{
            nascondiPrevBtn();
        }


    });

    $('#revisioneFinitureSelect').change(function(){
        var selectedPreventivo = parseInt($('#preventivoFinitureSelect option:selected').attr('class').split('-')[1]);
        var selectedRevisione = $('#revisioneFinitureSelect').val();
        stampaRiassuntoPreventivoFiniture(selectedPreventivo, selectedRevisione);

        statusPreventivo = true;

        {% for preventivo in preventiviFiniture %}

            if( parseInt('{{preventivo[0].numero_preventivo}}') == selectedPreventivo ){

                if( parseInt('{{preventivo[0].revisione}}') == selectedRevisione ){

                    statusPreventivo = '{{preventivo[0].stato}}';

                    if( statusPreventivo == 'True' )
                        statusPreventivo = true;
                    else
                        statusPreventivo = false;

                }
            }


        {% endfor %}

        if( !statusPreventivo ){
            $('.aCtrlPreventivoFiniture').children('a').hide();
            mostraBudgetBtn( selectedPreventivo, selectedRevisione);
        }
        else{
            $('.aCtrlPreventivoFiniture').children('a').show();
            nascondiBudgetBtn();
        }
    });

    $('#modificaPreventivoFiniture').click(function(){

            var selPrev = $('#preventivoFinitureSelect option:selected').attr('class').split('-')[1];
            var selectedRevisione = $('#revisioneFinitureSelect').val();



           socketFiniture.emit('modifica_preventivo_finiture', {'dip': '{{dipendente.username}}',
                                                                  'numero_preventivo': selPrev,
                                                                  'revisione': selectedRevisione});
    });


</script>